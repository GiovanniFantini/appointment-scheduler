name: Test Build and Run

on:
  push:
    branches:
      - 'claude/build-api-release-**'
  workflow_dispatch:

jobs:
  build-and-test-run:
    runs-on: ubuntu-latest
    name: Build, Publish and Test Run

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass123
          POSTGRES_DB: AppointmentScheduler
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore backend/AppointmentScheduler.API/AppointmentScheduler.API.csproj

      - name: Build in Release mode
        run: dotnet build backend/AppointmentScheduler.API/AppointmentScheduler.API.csproj --configuration Release --no-restore

      - name: Run tests (if any)
        run: dotnet test backend/AppointmentScheduler.API/AppointmentScheduler.API.csproj --configuration Release --no-build --verbosity normal || echo "No tests found"
        continue-on-error: true

      - name: Publish
        run: dotnet publish backend/AppointmentScheduler.API/AppointmentScheduler.API.csproj -c Release -o ./publish --no-build

      - name: Verify publish artifacts
        run: |
          echo "✓ Build completato con successo!"
          echo "✓ Pubblicazione completata!"
          echo ""
          echo "Artifact pubblicati:"
          ls -lh ./publish/
          echo ""
          echo "DLL principale:"
          ls -lh ./publish/AppointmentScheduler.API.dll

      - name: Test application startup
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=AppointmentScheduler;Username=postgres;Password=testpass123"
          JwtSettings__SecretKey: "test-secret-key-for-ci-pipeline-min-32-chars-long"
          JwtSettings__Issuer: "AppointmentScheduler.API"
          JwtSettings__Audience: "AppointmentScheduler.Client"
          JwtSettings__ExpirationMinutes: "1440"
          ASPNETCORE_ENVIRONMENT: "Development"
          RUN_MIGRATIONS: "true"
          SEED_DATABASE: "false"
        run: |
          echo "Testing application startup..."
          cd ./publish

          # Avvia l'applicazione in background
          timeout 30s dotnet AppointmentScheduler.API.dll > app.log 2>&1 &
          APP_PID=$!

          echo "Applicazione avviata con PID $APP_PID"
          echo "Attendendo 10 secondi per verificare l'avvio..."
          sleep 10

          # Verifica se il processo è ancora in esecuzione
          if kill -0 $APP_PID 2>/dev/null; then
            echo "✓ Applicazione avviata con successo!"
            echo ""
            echo "Log applicazione:"
            cat app.log

            # Termina l'applicazione
            kill $APP_PID
            echo ""
            echo "✓ Test di avvio completato con successo!"
          else
            echo "✗ Applicazione crashata durante l'avvio!"
            echo ""
            echo "Log applicazione:"
            cat app.log
            exit 1
          fi

      - name: Summary
        if: success()
        run: |
          echo "================================================"
          echo "✓ BUILD: SUCCESS"
          echo "✓ PUBLISH: SUCCESS"
          echo "✓ STARTUP TEST: SUCCESS"
          echo "================================================"
          echo ""
          echo "L'applicazione è pronta per il rilascio!"
